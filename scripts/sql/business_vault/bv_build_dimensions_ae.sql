/* *********************************************************************************** */
/* *** ARGUS Enterprise ************************************************************** */
/* *********************************************************************************** */

CREATE OR REPLACE TABLE DIMENSION_PROPERTY_AE AS (
  SELECT
      MD5(UPPER(e.PROPERTY_ID || '^' || i.PROPERTY_VERSION)) AS PK_DIMENSION_PROPERTY_AE
    , e.EXTERNAL_PROPERTY_ID
    , i.PROPERTY_VERSION
    , d.PROPERTY_NAME
    , d.VALUATION_DATE
    , d.RESALE_DATE
    , d.PROPERTY_TYPE_ENUM AS PROPERTY_TYPE
    , d.LOCAL_CURRENCY -- TODO: should this go to a junk dimension?
    , d.PROPERTY_AREA_MEASURE_ENUM AS PROPERTY_AREA_MEASURE -- TODO: should this go into a junk dimension?
    , d.PROPERTY_ARCHIVED
    , d.PROPERTY_DESCRIPTION
    , d.PROPERTY_COMMENTS
    , l.ADDRESS
  FROM
    DATA_VAULT.PIT_AE_PROPERTY                          i
    INNER JOIN DATA_VAULT.TRANSIENT_{SOURCE}_PROPERTY_VERSION t ON i.MD5_HUB_AE_PROPERTY = t.MD5_HUB_AE_PROPERTY AND i.PROPERTY_VERSION = t.PROPERTY_VERSION
    LEFT JOIN DATA_VAULT.LINK_AE_PROPERTY_EXT_PROPERTY  e ON i.MD5_HUB_AE_PROPERTY = e.MD5_HUB_AE_PROPERTY
    LEFT JOIN DATA_VAULT.SAT_AE_PROPERTY_DETAILS        d ON i.MD5_HUB_AE_PROPERTY = d.MD5_HUB_AE_PROPERTY AND i.LDTS_SAT_AE_PROPERTY_DETAILS = d.LDTS
    LEFT JOIN DATA_VAULT.SAT_AE_PROPERTY_LOCATION       l ON i.MD5_HUB_AE_PROPERTY = l.MD5_HUB_AE_PROPERTY AND i.LDTS_SAT_AE_PROPERTY_LOCATION = l.LDTS
);

CREATE OR REPLACE TABLE DIMENSION_LEASE_AE AS (
  SELECT
      MD5(UPPER(p.PROPERTY_ID || '^' || p.LEASE_ID || '^' || i.PROPERTY_VERSION)) AS PK_DIMENSION_LEASE_AE
    , e.EXTERNAL_LEASE_ID
    , d.IS_BASE_LEASE
    , d.TENANT_NAME
    , d.SUITE
    , d.TENURE
    , d.LEASE_TYPE_ENUM AS LEASE_TYPE
    , d.CUSTOM_LEASE_TYPE
    , d.LEASE_BEGIN
    , d.LEASE_EXPIRY
    , d.EXPIRY_TYPE_ENUM AS EXPIRY_TYPE
    , d.EARLIEST_BREAK
    , d.REMAINING_TERM_DAYS
    , d.LEASE_STATUS
    , d.LEASE_PERIOD_DAYS
    , d.MARKET_LEASE_PROFILE_NAME
    , d.RECOVERY_STRUCTURE_NAME
    , d.CPI_TYPE -- TODO: needs decoding
    , d.CPI_TIMING
    , d.CPI_RATE_OR_INDEX
  FROM
    DATA_VAULT.PIT_AE_LEASE                          i
    INNER JOIN DATA_VAULT.TRANSIENT_{SOURCE}_LEASE_VERSION t ON i.MD5_HUB_AE_LEASE = t.MD5_HUB_AE_LEASE AND i.PROPERTY_VERSION = t.PROPERTY_VERSION
    INNER JOIN DATA_VAULT.LINK_AE_LEASE_PROPERTY     p ON i.MD5_HUB_AE_LEASE = p.MD5_HUB_AE_LEASE
    LEFT JOIN DATA_VAULT.LINK_AE_LEASE_EXT_LEASE     e ON i.MD5_HUB_AE_LEASE = e.MD5_HUB_AE_LEASE
    LEFT JOIN DATA_VAULT.SAT_AE_LEASE_DETAILS        d ON i.MD5_HUB_AE_LEASE = d.MD5_HUB_AE_LEASE AND i.LDTS_SAT_AE_LEASE_DETAILS = d.LDTS
);

CREATE OR REPLACE TABLE DIMENSION_REVEX_AE AS (
  SELECT
      MD5(UPPER(p.PROPERTY_ID || '^' || p.REVEX_ID || '^' || i.PROPERTY_VERSION)) AS PK_DIMENSION_REVEX_AE
    , d.REVEX_NAME
    , d.REVEX_TYPE_ENUM AS REVEX_TYPE
    , d.ACCOUNT_CODE
    , d.SORT_ORDER
    , d.BASIS           -- TODO: needs decoding
    , d.START_DATE
    , d.UNIT_OF_MEASURE -- TODO: needs decoding    
  FROM
    DATA_VAULT.PIT_AE_REVEX                          i
    INNER JOIN DATA_VAULT.TRANSIENT_{SOURCE}_REVEX_VERSION t ON i.MD5_HUB_AE_REVEX = t.MD5_HUB_AE_REVEX AND i.PROPERTY_VERSION = t.PROPERTY_VERSION  
    INNER JOIN DATA_VAULT.LINK_AE_REVEX_PROPERTY     p ON i.MD5_HUB_AE_REVEX = p.MD5_HUB_AE_REVEX
    LEFT JOIN DATA_VAULT.SAT_AE_REVEX_DETAILS        d ON i.MD5_HUB_AE_REVEX = d.MD5_HUB_AE_REVEX AND i.LDTS_SAT_AE_REVEX_DETAILS = d.LDTS
);

CREATE OR REPLACE TABLE DIMENSION_LOAN_AE AS (
  SELECT
      MD5(UPPER(p.PROPERTY_ID || '^' || p.LOAN_ID || '^' || i.PROPERTY_VERSION)) AS PK_DIMENSION_LOAN_AE
    , d.LOAN_NAME
    , d.LOAN_TYPE_ENUM AS LOAN_TYPE
    , d.HOW_INPUT_ENUM AS HOW_INPUT
    , d.SENIORITY -- TODO: needs decoding
    , d.LOAN_DATE
    , d.LOAN_END 
  FROM
    DATA_VAULT.PIT_AE_LOAN                          i
    INNER JOIN DATA_VAULT.TRANSIENT_{SOURCE}_LOAN_VERSION t ON i.MD5_HUB_AE_LOAN = t.MD5_HUB_AE_LOAN AND i.PROPERTY_VERSION = t.PROPERTY_VERSION  
    INNER JOIN DATA_VAULT.LINK_AE_LOAN_PROPERTY     p ON i.MD5_HUB_AE_LOAN = p.MD5_HUB_AE_LOAN
    LEFT JOIN DATA_VAULT.SAT_AE_LOAN_DETAILS        d ON i.MD5_HUB_AE_LOAN = d.MD5_HUB_AE_LOAN AND i.LDTS_SAT_AE_LOAN_DETAILS = d.LDTS
);

CREATE OR REPLACE TABLE METADATA_LINE_ITEM_TYPE_AE AS (
SELECT
    h.LINE_ITEM_TYPE_NAME
  , d.LINE_ITEM_TYPE_ID
  , d.LINE_ITEM_TYPE_PARENT_ID
  , d.CLASS_TYPE
  , d.ACCOUNT_RELATION_TYPE
  , d.SORT_ORDER
  , d.REPORT_DESCRIPTION
  , d.REPORT_GROUP
  , d.SHOW_ENTITIES
  , d.IS_HEADER
  , d.COST_CODE_TYPE
  , d.LINEITEM_DEPTH
  , d.UNIT_OF_MEASURE_TYPE
  , d.LINEITEM_AGGREGATION_TYPE
  , d.RESULT_STORAGE_LOCATION
  , d.SECONDARY_RESULT_STORAGE_LOCATION
  , d.THIRD_RESULT_STORAGE_LOCATION
  , d.ACCOUNT_CODE
FROM DATA_VAULT.HUB_AE_LINE_ITEM_TYPE h
INNER JOIN DATA_VAULT.SAT_AE_LINE_ITEM_TYPE_DETAILS d ON h.MD5_HUB_AE_LINE_ITEM_TYPE = d.MD5_HUB_AE_LINE_ITEM_TYPE
);
